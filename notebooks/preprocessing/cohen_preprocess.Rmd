<!-- # --- -->
title: "preprocessing cohen data"
output: html_notebook
---

libs & init definitions
```{r}
data_root<-"/home/mcn26/palmer_scratch/tabula_data"
output_root="/home/mcn26/palmer_scratch/tabula_data/formatted"
#whether data should be automatically downloaded : run notebook once with true,
#then subsequently with false
download_data=TRUE
library(tidyverse)
library(Seurat)
```
Let's get the cohen data. Specifically, let's start with the mouse retina dataset. 
(my apologies for the R. Will be useful if we decide to play with the endogenous
transcriptome & need to load seurat objects). 

https://zenodo.org/records/7338678/files/scMPRA.zip?download=1

```{r}
zenodo=paste(data_root,"/scMPRA.zip",sep="")
unzipped_zenodo_path=paste(data_root,"/scMPRA",sep="")
if(download_data){
  download.file("https://zenodo.org/records/7338678/files/scMPRA.zip?download=1",zenodo)
  dir.create(unzipped_zenodo_path)
  unzip(zenodo,exdir=unzipped_zenodo_path)
  file.remove(zenodo)
}
```

```{r}
retina_MPRAbc_rep1=read_csv(paste(data_root,"/scMPRA/scMPRA/data/sc_expression_retina/retina_pBC_ec_rBC_ec_rep1.csv",sep=""))
retina_MPRAbc_rep2=read_csv(paste(data_root,"/scMPRA/scMPRA/data/sc_expression_retina/retina_pBC_ec_rBC_ec_rep2.csv",sep=""))
```
Preferable to have the two replicates in one tibble
```{r}
retina_MPRAbc_rep1 <- retina_MPRAbc_rep1 %>% mutate(rep_id=1)
retina_MPRAbc_rep2 <- retina_MPRAbc_rep2 %>% mutate(rep_id=2)
retina_MPRAbc <- bind_rows(retina_MPRAbc_rep1, retina_MPRAbc_rep2)
```

Kill the original variables to free some space. 
```{r}
rm(retina_MPRAbc_rep1,retina_MPRAbc_rep2)
gc()
```


```{r}
retina_MPRAbc_agg <- retina_MPRAbc %>%
  group_by(cellBC, rBC, name, pBC, cluster, rep_id) %>%
  summarise(
    total_count = sum(count),
    UMIs_MPRA_BC = n_distinct(umi),
    .groups = "drop"
  )
```

```{r}
retina_MPRAbc_agg
```



```{r}
retina_MPRAbc_agg<-retina_MPRAbc_agg %>% 
  rename(#new=old
    MPRA_BC=rBC,
    reads_MPRA_BC=total_count,
    cell_type_annotation=cluster,
    transfection_BC=pBC,
    CRE_id=name
  )
```
Reorder the columns
```{r}
retina_MPRAbc_agg<-retina_MPRAbc_agg %>% select(cellBC, rep_id, CRE_id,cell_type_annotation,MPRA_BC,reads_MPRA_BC,UMIs_MPRA_BC,transfection_BC)
```

Set untransfected to NA
```{r}
retina_MPRAbc_agg<-retina_MPRAbc_agg %>%
  mutate(
    MPRA_BC = if_else(MPRA_BC == "0", NA_character_, MPRA_BC),
    UMIs_MPRA_BC = if_else(is.na(MPRA_BC), NA_integer_, UMIs_MPRA_BC)
  )
```

dump to disc
```{r}
write.table(retina_MPRAbc_agg, file = paste(output_root,"COHEN_RETINA.tsv",sep="/"), sep = "\t", row.names = FALSE, quote = FALSE)
```


Ok, now let's take a look at the other dataset...

Data could be re-constructed from the zenodo, but it looks like a better (more 
processed) file is avilable from here:

[GSE188639_mixed_cell_bulk_exp.csv.gz](https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE188639&format=file&file=GSE188639%5Fmixed%5Fcell%5Fbulk%5Fexp%2Ecsv%2Egz)

```{r}
mixed_cell_path=paste(data_root,"GSE188639_mixed_cell_bulk_exp.csv.gz",sep="/")
if(download_data){
  download.file("https://www.ncbi.nlm.nih.gov/geo/download/?acc=GSE188639&format=file&file=GSE188639%5Fmixed%5Fcell%5Fbulk%5Fexp%2Ecsv%2Egz",mixed_cell_path)
}
```

```{r}

```

